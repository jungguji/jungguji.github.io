
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Junggu Ji, 생각의 기록">
    <title>아카이브 - Junggu Ji, 생각의 기록</title>
    <meta name="author" content="Junggu Ji">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Junggu Ji, 생각의 기록">
<meta property="og:url" content="https://jungguji.github.io/archives/page/2/index.html">
<meta property="og:site_name" content="Junggu Ji, 생각의 기록">
<meta property="og:locale" content="ko_KR">
<meta property="article:author" content="Junggu Ji">
<meta name="twitter:card" content="summary">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-vaqxmiojfeym1obe22l4wzlc2exrxuyy1hezfoyofzx2ow3vxa49a2skiig7.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162527815-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-162527815-1');
    </script>


    

    

    <script data-ad-client="ca-pub-6264654331856753" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/" aria-label>
            Junggu Ji, 생각의 기록
        </a>
    </div>
    
        
            <a class="header-right-picture " href="#about" aria-label="링크 열기: /#about">
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/" rel="noopener" title="Home">
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" rel="noopener" title="카테고리">
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">카테고리</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" rel="noopener" title="태그">
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" rel="noopener" title="아카이브">
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" rel="noopener" title="About">
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/jungguji" target="_blank" rel="external nofollow noopener noreferrer" title="GitHub">
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/mailto" rel="noopener" title="Mail">
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/atom.xml" rel="noopener" title="RSS">
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1" class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2022/04/30/Jackson-JsonCreator%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94/" aria-label=": Jackson @JsonCreator를 이용한 역직렬화">
                            Jackson @JsonCreator를 이용한 역직렬화
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-04-30T22:00:35+09:00">
	
		    2022/04/30
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>어쩌다 보니 연속해서 @RequestBody에 관한 글을 작성하게 되었는데… 이전에 말했던 것 처럼 @RequestBody는 Jackson 라이브러리를 사용하기 때문에 기본생성자를 이용해 object(DTO)를 바인딩한다. 그 때문에 다른 생성자에서 validtion등을 처리했다고 해도 당연히 처리되지 않는데 이 때 사용할 수 있는 @JsonCreator에 대해 알아본다.</p>
<hr>
<h2 id="본론"><a href="#본론" class="headerlink" title="본론"></a>본론</h2><h3 id="현재-상황"><a href="#현재-상황" class="headerlink" title="현재 상황"></a>현재 상황</h3><img src="/2022/04/30/Jackson-JsonCreator%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94/1.JPG" class title="Jackson @JsonCreator를 이용한 역직렬화">

<br>

<img src="/2022/04/30/Jackson-JsonCreator%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94/2.JPG" class title="Jackson @JsonCreator를 이용한 역직렬화">

<br>

<p>위 이미지들 처럼 Controller와 dto를 만들었다고 했을 때, /test 를 호출해보면 어떻게 될까?</p>
<img src="/2022/04/30/Jackson-JsonCreator%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94/3.JPG" class title="Jackson @JsonCreator를 이용한 역직렬화">

<br>

<p>@RequestBody를 사용 할 경우 Jackson 라이브러리를 사용해서 기본 생성자를 이용해 매핑시키기 때문에 “여기타고 생성이 될까요?” 라는 로그는 찍히지 않는다.</p>
<p>이 때, DTO에 처리 혹은 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/util/Assert.html">Assert</a> 등을 이용한 validtion을 추가하고 싶다면 어떻게 될까?</p>
<p>생성자에 추가해서 처리하면 좋겠지만, 기본 생성자를 이용해서 생성되므로, controller 혹은 service 단에서 처리해야 한다.(물론 validtion의 경우엔 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.oracle.com/javaee/7/api/javax/validation/Valid.html">@Valid</a>를 통해 어느정도 처리 가능하다.)</p>
<p>이런 경우, 기본 생성자가 아닌 다른 생성자를 이용해 dto를 바인딩 시키고 싶은 경우 사용 할 수 있는 annotation이 바로 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://fasterxml.github.io/jackson-annotations/javadoc/2.6/com/fasterxml/jackson/annotation/JsonCreator.html">@JsonCreator</a>이다.</p>
<p>이제 다시 코드로 돌아와서, 이 @JsonCreator를 생성자에 선언 해놓고 다시 /test를 요청한다면</p>
<img src="/2022/04/30/Jackson-JsonCreator%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94/4.JPG" class title="Jackson @JsonCreator를 이용한 역직렬화">

<br>

<p>아까와 다르게 @Builder 패턴이 적용된 생성자를 통해 바인딩 되어서 “여기타고 생성이 될까요?” 라는 로그가 정상적으로 찍힌 걸 볼 수 있다.</p>
<hr>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>이제 우리는 @RequestBody를 사용할 때 기본 생성자만이 아닌 다른 생성자로도 DTO를 바인딩 할 수 있게 되었으므로, @Valid보다 더 정교한 validtion이나, String을 encoding 해야 할 경우에도 service나 controller가 아닌 생성자에서 처리 할 수 있게 되었으므로 테스트도 더 간편하게 할 수 있게 되었다.</p>
<p>번외로 보통 @JsonCreator는 인스턴스화 할 때 사용 할 생성자를 정의 할 때 사용 하는 annotation으로,<br>보통 아래 코드처럼 @JsonProperty와 같이 사용해서 엔티티와 완벽히 일치되지 않는 JSON을 역직렬화할 때 주로 사용하는 것 같다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanWithCreator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BeanWithCreator</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="meta">@JsonProperty(&quot;id&quot;)</span> <span class="keyword">int</span> id, </span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="meta">@JsonProperty(&quot;theName&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>개인적으로 이렇게 쓸 일이 몇 번이나 있을까 싶긴하지만…</p>
<hr>
<h2 id="전체-코드"><a href="#전체-코드" class="headerlink" title="전체 코드"></a>전체 코드</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/jungguji/blog-example-code">https://github.com/jungguji/blog-example-code</a></li>
</ul>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.baeldung.com/jackson-annotations">https://www.baeldung.com/jackson-annotations</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://fasterxml.github.io/jackson-annotations/javadoc/2.6/com/fasterxml/jackson/annotation/JsonCreator.html">https://fasterxml.github.io/jackson-annotations/javadoc/2.6/com/fasterxml/jackson/annotation/JsonCreator.html</a></li>
<li></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2022/04/30/Jackson-JsonCreator%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2022/03/31/RequestBody-%EB%B0%94%EC%9D%B8%EB%94%A9/" aria-label=": RequestBody 바인딩">
                            RequestBody 바인딩
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-03-31T22:44:43+09:00">
	
		    2022/03/31
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>이전에 작성한 글 중에 <a href="https://jungguji.github.io/2021/02/05/Requestbody-Annotation-%EC%82%AC%EC%9A%A9-%EC%8B%9C-%EA%B8%B0%EB%B3%B8-%EC%83%9D%EC%84%B1%EC%9E%90-%ED%95%84%EC%9A%94/">@Requestbody Annotation 사용 시 기본 생성자 필요</a> 라는<br>글을 올린 적이 있는데 글의 마지막에 보면</p>
<blockquote><p>@Requestbody가 jackson 라이브러리를 이용해 매핑하기 때문이다.</p>
<footer><strong>JG.JI</strong><cite>@Requestbody Annotation 사용 시 기본 생성자 필요</cite></footer></blockquote>

<br>

<p>라는 결론으로 글을 마무리 하였는데, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1/dashboard">김영한님의 강의</a>에서 해당 내용과 관련해서 자세하게 알려주시는 부분이 있어, 해당 내용을 정리해본다.</p>
<hr>
<h2 id="본론"><a href="#본론" class="headerlink" title="본론"></a>본론</h2><p>우선 Spring에서는 Controller에서 @RequestBody로 넘어오는 파라미터들에 대해서 내부적으로 ObjectMapper를 이용해 JSON 데이터를 우리가 만든 DTO 객체로 변환시켜주고,<br>@ResponseBody인 경우엔, DTO 객체를 JSON 데이터로 변환해서 클라이언트에 넘겨준다.</p>
<p>이렇게해서 해소 될 궁금증이었으면 이 글을 읽으러 오지 않았을테니, 해당 내용에 대하여 코드 레벨에서 자세히 알아보기로 한다.</p>
<p>우선, Spring MVC의 동작 순서를 간략하게 서술하자면(구글에 검색하면 훌륭한 분들이 작성하신 훌륭한 글들이 많으므로)</p>
<ol>
<li>클라이언트에서 요청이 넘어오면 FrontController 역할을 수행하는 DispatcherServlet에서 먼저 확인해서,</li>
<li>핸들러 매핑 리스트 중 해당 요청을 처리 할 수 있는 핸들러를 가져오고,</li>
<li>핸들러 어댑터 리스트 중에서 해당 핸들러를 처리 할 수 있는 핸들러 어댑터를 가져와서,</li>
<li>해당 어댑터에서 우리가 만든 컨트롤러에 호출해서 비즈니스 로직을 처리 한 후,</li>
<li>리턴되는 데이터에 맞게 뷰 리졸버나 메시지컨버터가 동작하고,</li>
<li>알맞게 클라이언트로 반환된다.</li>
</ol>
<p>여기서, @RequestMapping에 대한 request는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/RequestMappingHandlerAdapter.html">RequestMappingHandlerAdapter</a>에서 처리하는데<br>이 RequestMappingHandlerAdapter는<br>    1. byte[]를 처리하기 위한 ByteArrayHttpMessageConverter<br>    2. String을 처리하기 위한 StringHttpMessageConverter<br>    3. json을 처리하기 위한 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/index.html?org/springframework/http/converter/json/MappingJackson2HttpMessageConverter.html">MappingJackson2HttpMessageConverter</a><br>등을 가지고 있다.</p>
<h3 id="RequestMappingHandlerAdapter에-설정된-MessageConverter들"><a href="#RequestMappingHandlerAdapter에-설정된-MessageConverter들" class="headerlink" title="RequestMappingHandlerAdapter에 설정된 MessageConverter들"></a>RequestMappingHandlerAdapter에 설정된 MessageConverter들</h3><img src="/2022/03/31/RequestBody-%EB%B0%94%EC%9D%B8%EB%94%A9/1_RequestMappingHandlerAdapter_messageConverters.JPG" class title="RequestBody 바인딩 RequestMappingHandlerAdapter에 설정된 MessageConverter들 " alt="RequestMappingHandlerAdapter에 설정된 MessageConverter들">

<br>

<p>그리고 자신이 가지고 있는 ArgumentResolver들 중<br>@RequestBody형식으로 들어오는 파라미터를 처리하기 위해 RequestResponseBodyMethodProcessor 라는 ArgumentResolver를 호출한다.</p>
<h3 id="RequestMappingHandlerAdapter에-설정된-ArgumentResolver들"><a href="#RequestMappingHandlerAdapter에-설정된-ArgumentResolver들" class="headerlink" title="RequestMappingHandlerAdapter에 설정된 ArgumentResolver들"></a>RequestMappingHandlerAdapter에 설정된 ArgumentResolver들</h3><img src="/2022/03/31/RequestBody-%EB%B0%94%EC%9D%B8%EB%94%A9/2_RequestMappingHandlerAdapter_ArgumentResolvers.JPG" class title="RequestBody 바인딩">

<br>

<p>이 RequestResponseBodyMethodProcessor의 readWithMessageConverters 메서드에서 메시지 컨버터 리스트를 loop 돌면서<br>대상 클래스 타입과 미디어 타입 등을 체크해서 알맞은 메시지 컨버터를 호출해서 사용하는데<br>이 때 호출되는 MessageConverter가 MappingJackson2HttpMessageConverter라는 MessageConverter이다.</p>
<h3 id="요청을-처리-할-수-있는-MessageConverter-호출"><a href="#요청을-처리-할-수-있는-MessageConverter-호출" class="headerlink" title="요청을 처리 할 수 있는 MessageConverter 호출"></a>요청을 처리 할 수 있는 MessageConverter 호출</h3><img src="/2022/03/31/RequestBody-%EB%B0%94%EC%9D%B8%EB%94%A9/3_AbstractMessageConverterMethodArgumentResolver_readWithMessageConverters.JPG" class title="RequestBody 바인딩">

<ol>
<li>MessageConverter의 canRead() 메서드로 해당 요청을 처리 할 수 있는 컨버터 인지 확인.</li>
<li>처리 할 수 있으면 read() 메서드로 메시지에서 객체를 읽고 반환한다.</li>
</ol>
<br>

<p>MappingJackson2HttpMessageConverter에서는 최종적으로 readJavaType 메서드가 호출되는데 이 때 objectMapper를 사용해서 json 데이터를 DTO 객체로 변환하는 것을 볼 수 있다.</p>
<h3 id="ObjectMapper를-이용해서-JSON데이터를-변환하는-부분"><a href="#ObjectMapper를-이용해서-JSON데이터를-변환하는-부분" class="headerlink" title="ObjectMapper를 이용해서 JSON데이터를 변환하는 부분"></a>ObjectMapper를 이용해서 JSON데이터를 변환하는 부분</h3><img src="/2022/03/31/RequestBody-%EB%B0%94%EC%9D%B8%EB%94%A9/4_AbstractJackson2HttpMessageConverter_readJavaType.JPG" class title="RequestBody 바인딩">

<hr>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>보이지 않는 곳에서 이렇게 많은 부분을 스프링에서 처리해주고 있었기 때문에 우리는 Controller에서 편하게 파라미터를 사용 할 수 있고, JSON 데이터도 바로 객체로 받을 수 있는 것이었다.<br>이런 내용을 알아도, 몰라도 결국 같은 방식으로 개발 하겠지만… 언젠가 도움이 되겠거니 생각하고 지금은 궁금증을 해결 했다는 것에 대해 만족한다.<br>이 글을 읽는 다른 분들도 필자와 같은 궁금증이 있었다면 조금이나마 해소가 됐길 바라며..</p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://velog.io/@conatuseus/RequestBody%EC%97%90-%EA%B8%B0%EB%B3%B8-%EC%83%9D%EC%84%B1%EC%9E%90%EB%8A%94-%EC%99%9C-%ED%95%84%EC%9A%94%ED%95%9C%EA%B0%8">https://velog.io/@conatuseus/RequestBody%EC%97%90-%EA%B8%B0%EB%B3%B8-%EC%83%9D%EC%84%B1%EC%9E%90%EB%8A%94-%EC%99%9C-%ED%95%84%EC%9A%94%ED%95%9C%EA%B0%8</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://csy7792.tistory.com/317">https://csy7792.tistory.com/317</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1">김영한 - 스프링 MVC 1편 - 백엔드 웹 개발 핵심 기술</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2022/03/31/RequestBody-%EB%B0%94%EC%9D%B8%EB%94%A9/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/11/21/content-type-application-x-www-form-urlencoded%EB%8A%94-POST%EB%B0%A9%EC%8B%9D%EC%9C%BC%EB%A1%9C%EB%A7%8C/" aria-label=": content-type application/x-www-form-urlencoded는 POST방식으로만">
                            content-type application/x-www-form-urlencoded는 POST방식으로만
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-11-21T22:18:58+09:00">
	
		    2021/11/21
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>오늘도 어김없이 영한님의 스프링 MVC 강의를 듣고 있었는데, html form 데이터를 body에 보낼 때는 post 방식 밖에 안된다는 말씀을 하시기에…<br>‘그럼 GET 방식도 안된다는건가?’ 라는 궁금증이 들어서 직접 확인해본 결과에 대해 작성한다.</p>
<hr>
<h2 id="본론"><a href="#본론" class="headerlink" title="본론"></a>본론</h2><p>우선… 기본적으로 지금 필요한 GET방식과 POST방식의 차이점만을 다시 상기해보자면, GET방식은 데이터가 URL의 query string으로 들어간다는 것과,<br>POST방식은 데이터가 http message-body에 들어간다는 차이만 알아두면 될 것 같다. (다른 많은 차이가 있지만)</p>
<p>그렇기 때문에 우리가 html form 태그 에서 method attribute에 GET라고 작성한 후 데이터를 submit하면 데이터는 query string에 담겨 서버로 전송되고<br>POST라고 작성한 후 데이터를 submit하면 데이터는 message-body에 담겨서 서버로 전성되고 이 때 content-type은 application/x-www-form-urlencoded로 전송된다.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/request-param&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> /&gt;</span></span><br><span class="line">    age:      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>전송<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="/2021/11/21/content-type-application-x-www-form-urlencoded%EB%8A%94-POST%EB%B0%A9%EC%8B%9D%EC%9C%BC%EB%A1%9C%EB%A7%8C/1.JPG" class title="content-type application&#x2F;x-www-form-urlencoded는 POST방식으로만">

<p>그럼 method는 GET이면서 content-type은 application/x-www-form-urlencoded 일 경우엔 어떻게 될까?</p>
<p>postman으로 아래처럼 실행해본 결과 보는 것과 같이 400 error가 응답되며 요청에 실패하였다.</p>
<img src="/2021/11/21/content-type-application-x-www-form-urlencoded%EB%8A%94-POST%EB%B0%A9%EC%8B%9D%EC%9C%BC%EB%A1%9C%EB%A7%8C/2.JPG" class title="content-type application&#x2F;x-www-form-urlencoded는 POST방식으로만">

<p>어째서 이런 일이 발생하였나를 코드 레벨에서 확인해보니…</p>
<p>tomcat의 Request class에 있는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://tomcat.apache.org/tomcat-8.5-doc/api/org/apache/catalina/connector/Request.html#parseParameters()">parseParameters()</a>라는 메서드에서 넘어온 데이터를 parsing 하는데,<br>이 때 http method가 post인지 확인하고 post가 아니라면 message-body의 데이터를 파싱 할 수 없게 되어 있는 것을 확인했다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( !getConnector().isParseBodyMethod(getMethod()) ) &#123;</span><br><span class="line">    success = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 이 아래부턴 Connector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isParseBodyMethod</span><span class="params">(String method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parseBodyMethodsSet.contains(method);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">null</span> == parseBodyMethodsSet) &#123;</span><br><span class="line">    setParseBodyMethods(getParseBodyMethods());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set list of HTTP methods which should allow body parameter</span></span><br><span class="line"><span class="comment"> * parsing. This defaults to &lt;code&gt;POST&lt;/code&gt;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> methods Comma separated list of HTTP method names</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParseBodyMethods</span><span class="params">(String methods)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    HashSet&lt;String&gt; methodSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != methods) &#123;</span><br><span class="line">        methodSet.addAll(Arrays.asList(methods.split(<span class="string">&quot;\\s*,\\s*&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (methodSet.contains(<span class="string">&quot;TRACE&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(sm.getString(<span class="string">&quot;coyoteConnector.parseBodyMethodNoTrace&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.parseBodyMethods = methods;</span><br><span class="line">    <span class="keyword">this</span>.parseBodyMethodsSet = methodSet;</span><br><span class="line">    setProperty(<span class="string">&quot;parseBodyMethods&quot;</span>, methods);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the HTTP methods which will support body parameters parsing</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getParseBodyMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.parseBodyMethods;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Comma-separated list of HTTP methods that will be parsed according</span></span><br><span class="line"><span class="comment"> * to POST-style rules for application/x-www-form-urlencoded request bodies.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> String parseBodyMethods = <span class="string">&quot;POST&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>위에 정리한 것 처럼</p>
<ol>
<li>isParseBodyMethod()에서 지금 request의 method가 body를 파싱 할 수 있는 메서드 인지 확인하는데, 이 때 가능한 method들은 인스턴스 변수 parseBodyMethodsSet에 저장되어 있고,</li>
<li>인스턴스 변수 parseBodyMethodsSet는 setParseBodyMethods() 메서드에서 저장되고 있고~</li>
<li>parseBodyMethodsSet가 null인 경우에</li>
<li>setParseBodyMethods(getParseBodyMethods()) 메서드를 실행해서 이 때 method를 저장 시키는데,</li>
<li>getParseBodyMethods() 메서드를 호출하면</li>
<li>인스턴스변수 parseBodyMethods를 return 하는데</li>
<li>이 때 이 인스턴스 변수 parseBodyMethods에는 이미 “POST”로 method가 지정되어 있기 때문에</li>
<li>GET방식 일 경우에는 message-body를 파싱 할 수 있는 method가 아닌 것으로 처리 되므로~</li>
<li>파싱 할 수 없다는 에러 메시지를 출력하면서 프로세스가 끝이난다.</li>
</ol>
<hr>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>생각해보면… content-type은 message-body이 어떤 형식의 데이터로 담겨 있는가를 알려주는 일종의 os의 파일 확장자같은 개념인데<br>당연히 get방식의 경우 message-body에 데이터가 담기는 것이 아니니 get방식으로 content-type만 application/x-www-form-urlencoded로 한다고 될 턱이 없는데<br>강의를 듣기만 했을 때는 왜 생각하지 못했는 지 모르겠다.. 머리가 나쁘면 몸이 고생이라더니 옛말에 틀린 말이 없다.</p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Content-Type">https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Content-Type</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://datatracker.ietf.org/doc/html/rfc7231#section-3.1.1.5">https://datatracker.ietf.org/doc/html/rfc7231#section-3.1.1.5</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html">https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/11/21/content-type-application-x-www-form-urlencoded%EB%8A%94-POST%EB%B0%A9%EC%8B%9D%EC%9C%BC%EB%A1%9C%EB%A7%8C/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/11/15/spring%EC%97%90%EC%84%9C-request-header%EB%A5%BC-parsing-%ED%95%98%EB%8A%94-%EB%B2%95/" aria-label=": spring에서 request header를 parsing 하는 법">
                            spring에서 request header를 parsing 하는 법
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-11-15T21:44:15+09:00">
	
		    2021/11/15
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>우선 사과의 말씀부터 올린다. 제목은 ‘spring에서~’ 지만 정확히는 tomcat에서 ~ 로 보는 것이 맞다.</p>
<p>인프런에서 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1/dashboard">김영한 님의 Spring MVC 강의</a>를 보던 도중 … ‘http request를 정확히 어떠한 방식으로 파싱하고 있을까?’라는 궁금증이 생겨서 강의를 듣다가 말고 삽질을 한 내용을 기록해둔다.</p>
<hr>
<h2 id="본론"><a href="#본론" class="headerlink" title="본론"></a>본론</h2><p>우선, 처음으로 궁금증을 해결하기 위해 들어가본 곳은 http request 요청을 받기 위한 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://javaee.github.io/javaee-spec/javadocs/javax/servlet/http/HttpServletRequest.html">HttpServletRequest interface</a>의 tomcat 구현체인 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/connector/RequestFacade.html">RequestFacade</a> class부터 시작했다.</p>
<p>이 중 getHeader 메서드에 대해 찾아보면,</p>
<blockquote><p>Returns the value of the specified request header as a String.<br>If the request did not include a header of the specified name, this method returns null.<br>If there are multiple headers with the same name, this method returns the first head in the request.<br>The header name is case insensitive.<br>You can use this method with any request header.</p>
<footer><strong>RequestFacade</strong><cite><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/connector/RequestFacade.html#getHeader(java.lang.String)">RequestFacade</a></cite></footer></blockquote>

<p>라고 설명되어 있고… 이 때 코드에서 request의 header를 살펴보면</p>
<img src="/2021/11/15/spring%EC%97%90%EC%84%9C-request-header%EB%A5%BC-parsing-%ED%95%98%EB%8A%94-%EB%B2%95/1.JPG" class title="spring에서 request header를 parsing 하는 법 이미 header에 정보들이 저장되어 있는 상태 " alt="이미 header에 정보들이 저장되어 있는 상태">

<p>이미지와 같이 이미 header에 대한 정보들이 각각 저정되어 있는 걸 볼 수 있다.</p>
<p>필자가 궁금했던 것은 ‘이 request에 header는 언제 저장되는가?’ 였으므로<br>막연하게 ‘여기서 더 타고 올라가면 찾아 낼 수 있겠구나..’ 라고 안일한(?) 생각을 하고 안으로 더 들어가보았다.</p>
<p>타고타고 가다보니 …<br>http 1.1 header에 의한 요청이므로 Http11Processor의 service 메서드에서</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Don&#x27;t parse headers for HTTP/0.9</span></span><br><span class="line"><span class="keyword">if</span> (!http09 &amp;&amp; !inputBuffer.parseHeaders()) &#123;</span><br><span class="line">    <span class="comment">// We&#x27;ve read part of the request, don&#x27;t recycle it</span></span><br><span class="line">    <span class="comment">// instead associate it with the socket</span></span><br><span class="line">    openSocket = <span class="keyword">true</span>;</span><br><span class="line">    readComplete = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>처럼 작성되어 있는 코드를 발견했고, 여기에 있는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/coyote/http11/Http11InputBuffer.html">inputBuffer</a>.parseHeaders() 을 보니<br>이름부터 여기서 http request에 대해 파싱을 할 것 같아 이 안으로 들어가보았다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (headerParsePos == HeaderParsePosition.HEADER_NAME) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read new bytes if needed</span></span><br><span class="line">    <span class="keyword">if</span> (byteBuffer.position() &gt;= byteBuffer.limit()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!fill(<span class="keyword">false</span>)) &#123; <span class="comment">// parse header</span></span><br><span class="line">            <span class="keyword">return</span> HeaderParseStatus.NEED_MORE_DATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pos = byteBuffer.position();</span><br><span class="line">    chr = byteBuffer.get();</span><br><span class="line">    <span class="keyword">if</span> (chr == Constants.COLON) &#123;</span><br><span class="line">        headerParsePos = HeaderParsePosition.HEADER_VALUE_START;</span><br><span class="line">        headerData.headerValue = headers.addValue(byteBuffer.array(), headerData.start,</span><br><span class="line">                pos - headerData.start);</span><br><span class="line">        pos = byteBuffer.position();</span><br><span class="line">        <span class="comment">// Mark the current buffer position</span></span><br><span class="line">        headerData.start = pos;</span><br><span class="line">        headerData.realPos = pos;</span><br><span class="line">        headerData.lastSignificantChar = pos;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!HttpParser.isToken(chr)) &#123;</span><br><span class="line">        <span class="comment">// Non-token characters are illegal in header names</span></span><br><span class="line">        <span class="comment">// Parsing continues so the error can be reported in context</span></span><br><span class="line">        headerData.lastSignificantChar = pos;</span><br><span class="line">        byteBuffer.position(byteBuffer.position() - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// skipLine() will handle the error</span></span><br><span class="line">        <span class="keyword">return</span> skipLine();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chr is next byte of header name. Convert to lowercase.</span></span><br><span class="line">    <span class="keyword">if</span> ((chr &gt;= Constants.A) &amp;&amp; (chr &lt;= Constants.Z)) &#123;</span><br><span class="line">        byteBuffer.put(pos, (<span class="keyword">byte</span>) (chr - Constants.LC_OFFSET));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>들어가서보니 해당 코드처럼</p>
<p>현재 header data의 파싱된 위치가 key, value 형식의 데이터인 header의 name 부분 이라면 계속 반복하면서 버퍼에 저장하고 COLON(:) 을 만나게 되면,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">headerData.headerValue = headers.addValue(byteBuffer.array(), headerData.start,</span><br><span class="line">                        pos - headerData.start);</span><br></pre></td></tr></table></figure>

<p>코드가 실행되면서 아까 봤던 request의 MimeHeaders 타입인 header에 name으로 저장되고</p>
<p>value에도 위와 같은 방식으로 byte 단위로 이동하고 저장되면서 header에 value에 저장된다.</p>
<hr>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>서블릿이 http 통신을 위해 귀찮은 것들을 해준다는 것은 알고 있었지만<br>실제로 어떻게 하고 지에 대해서는 신경을 안 쓰고 있었는데 이렇게 강의를 듣다 보니 궁금해서 한번 확인해보았다.</p>
<p>만일 이 작업을 서블릿에서 대신 안해주지 않고 개발자가 개발할 때마다 해줘야한다고 생각하면…<br>머리가 어지러워지는 것 같아 이만 글을 줄인다…</p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1/dashboard">스프링 MVC 1편 - 백엔드 웹 개발 핵심 기술</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/11/15/spring%EC%97%90%EC%84%9C-request-header%EB%A5%BC-parsing-%ED%95%98%EB%8A%94-%EB%B2%95/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/" aria-label=": 애플 팀 변경 시 유저 정보 migration하기">
                            애플 팀 변경 시 유저 정보 migration하기
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-10-31T20:24:57+09:00">
	
		    2021/10/31
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>현재 운영 중인 서비스가 어른들의 사정(?)으로 기존에 앱스토어에 올라와있던 어플의 팀을 이전해야 하는 경우가 생겼는데 이 때 팀 변경 후(정확히는 변경 후, Service Ids를 새로 생성한 후) 기존 애플 유저들의 계정이 로그인 되지 않고 가입 프로세스를 타게 되었는데, 이를 해결 하기 위해 이전 된 팀으로 기존 유저 정보를 마이그레이션 하는 방법을 정리 해둔다.</p>
<hr>
<h2 id="본론"><a href="#본론" class="headerlink" title="본론"></a>본론</h2><h3 id="1-기존-팀-Key-file로-client-secret-생성"><a href="#1-기존-팀-Key-file로-client-secret-생성" class="headerlink" title="1. 기존 팀 Key file로 client_secret 생성"></a>1. 기존 팀 Key file로 client_secret 생성</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;jwt&#x27;</span></span><br><span class="line"></span><br><span class="line">key_file = <span class="string">&#x27;기존 키파일명&#x27;</span></span><br><span class="line">team_id = <span class="string">&#x27;기존 팀 아이디&#x27;</span></span><br><span class="line">client_id = <span class="string">&#x27;클라이언트 아이디&#x27;</span></span><br><span class="line">key_id = <span class="string">&#x27;기존 키 아이디&#x27;</span></span><br><span class="line"></span><br><span class="line">ecdsa_key = OpenSSL::PKey::EC.new IO.read key_file</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">  <span class="string">&#x27;kid&#x27;</span> =&gt; key_id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">claims = &#123;</span><br><span class="line">    <span class="string">&#x27;iss&#x27;</span> =&gt; team_id,</span><br><span class="line">    <span class="string">&#x27;iat&#x27;</span> =&gt; Time.now.to_i,</span><br><span class="line">    <span class="string">&#x27;exp&#x27;</span> =&gt; Time.now.to_i + <span class="number">86400</span>*<span class="number">180</span>,</span><br><span class="line">    <span class="string">&#x27;aud&#x27;</span> =&gt; <span class="string">&#x27;https://appleid.apple.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sub&#x27;</span> =&gt; client_id,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">token = JWT.encode claims, ecdsa_key, <span class="string">&#x27;ES256&#x27;</span>, headers</span><br><span class="line"></span><br><span class="line">puts token</span><br></pre></td></tr></table></figure>

<ol>
<li>위 코드를 복사해서 ruby script 파일(.rb)로 만든다.</li>
<li>키 파일과 작성한 script 파일을 같은 디렉토리 내에 위치 시킨다.</li>
<li>터미널에서 .rb 스크립트를 실행 시킨다.</li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ruby 스크립트와 키파일이 존재하는 디렉토리로 이동</span></span><br><span class="line">cd /Users/user/Documents/apple_client</span><br><span class="line"></span><br><span class="line"><span class="comment"># ruby 스크립트 실행</span></span><br><span class="line">ruby client_secret.rb</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>스크립트가 정상적으로 실행됐으면 client_secret이 생성됨</li>
</ol>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Ignoring ffi-1.15.0 because its extensions are not built. Try: gem pristine ffi --version 1.15.0</span><br><span class="line"># 아래</span><br><span class="line">eyJraWQiOiJHMzg2UlM3MlY3IiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiXXXXXXXXXxxxTJSOVM1IiwiaWF0IjoxNjM1MzAwOTY0LCJleHAiOjE2NTA4NTI5NjQsImxxxxxxXXXBzOi8vYXBwbGVpZC5hcHBsZS5jb20iLCJzdWIiOiJjb20uampsZWUuV2VkUXVlZW4ifQ.Zw18dKVQxxxxxXXXXXXeSVMT8B_aTkVHULNPOal7W_n_KTba3WtYwE-fQh8Ru6GhmNdVbx2VD1TnPBjTZmKB6PaZ58w</span><br></pre></td></tr></table></figure>

<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/1.png" class title="애플 팀 변경 시 유저 정보 migration하기">

<hr>
<h3 id="2-access-token-생성"><a href="#2-access-token-생성" class="headerlink" title="2. access_token 생성"></a>2. access_token 생성</h3><ul>
<li>기존 provider_id를 transfer 하기 위해선 apple api로 통신해야하는데 이 때 필요한 access_token을 생성한다.</li>
<li>POST 요청을 전송하기 위해 postman(<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.postman.com/">https://www.postman.com/</a>)을 사용</li>
<li>참고 document (<a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.apple.com/documentation/sign_in_with_apple/transferring_your_apps_and_users_to_another_team">https://developer.apple.com/documentation/sign_in_with_apple/transferring_your_apps_and_users_to_another_team</a>)</li>
</ul>
<ol>
<li>request 작성</li>
</ol>
<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/2.png" class title="애플 팀 변경 시 유저 정보 migration하기">

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">URL : https://appleid.apple.com/auth/token</span><br><span class="line">HTTP Method : POST</span><br><span class="line">Content-Type : x-www-form-urlencoded</span><br><span class="line">Body : </span><br><span class="line">&#123;</span><br><span class="line">    grant_type : client_credentials</span><br><span class="line">    scope : user.migration</span><br><span class="line">    client_id : 클라이언트 아이디</span><br><span class="line">    client_secret : 위에서 생성한 client_secret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>요청 후 결과 확인</li>
</ol>
<ul>
<li>정상적으로 응답이 온다면 아래처럼 1시간 짜리 access_token이 발급된다.</li>
<li>1 시간이 경과하면 재발급을 받아야 한다.</li>
</ul>
<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/3.png" class title="애플 팀 변경 시 유저 정보 migration하기">

<hr>
<h3 id="3-기존-유저-provider-Id-transfer"><a href="#3-기존-유저-provider-Id-transfer" class="headerlink" title="3. 기존 유저 provider Id transfer"></a>3. 기존 유저 provider Id transfer</h3><ul>
<li>변경된 팀의 provider Id로 변경하기 전 단계</li>
<li>여기서 응답받은 transfer_sub 으로 다시 변경 요청을 보내야 변경된 팀 provider id를 받을 수 있음</li>
</ul>
<ol>
<li>request 작성</li>
</ol>
<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/4.png" class title="애플 팀 변경 시 유저 정보 migration하기 access_token 설정 token_type이 bearer였으므로, bearer token으로 설정 " alt="access_token 설정 token_type이 bearer였으므로, bearer token으로 설정">

<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/5.png" class title="애플 팀 변경 시 유저 정보 migration하기">

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">URL : https://appleid.apple.com/auth/usermigrationinfo</span><br><span class="line">HTTP Method : POST</span><br><span class="line">Content-Type : x-www-form-urlencoded</span><br><span class="line">Authorization: Bearer &#123;access_token&#125;</span><br><span class="line">Body : </span><br><span class="line">&#123;</span><br><span class="line">    sub : 기존 유저 Provider Id</span><br><span class="line">    target : 새로 만든 팀 ID</span><br><span class="line">    client_id : 클라이언트 아이디</span><br><span class="line">    client_secret : 위에서 생성한 client_secret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>요청 후 결과 확인</li>
</ol>
<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/6.png" class title="애플 팀 변경 시 유저 정보 migration하기">

<hr>
<h3 id="4-변경된-팀-Provider-Id로-transfer"><a href="#4-변경된-팀-Provider-Id로-transfer" class="headerlink" title="4. 변경된 팀 Provider Id로 transfer"></a>4. 변경된 팀 Provider Id로 transfer</h3><ul>
<li>참고 document<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.apple.com/documentation/sign_in_with_apple/bringing_new_apps_and_users_into_your_team">https://developer.apple.com/documentation/sign_in_with_apple/bringing_new_apps_and_users_into_your_team</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.apple.com/forums/thread/666734">https://developer.apple.com/forums/thread/666734</a></li>
</ul>
</li>
<li>필자는 이 단계가 존재한다는 걸 몰라서 문제 해결에 많은 시간이 소요 되었다…</li>
</ul>
<ol>
<li>requset 생성<ul>
<li>이 때 전송되는 client_secret은 새로 만든 팀의 키 파일로 생성된 client_secret이다.</li>
<li>이 때 전송되는 client_secret은 새로 만든 팀의 키 파일로 생성된 client_secret이다.</li>
<li>이 때 전송되는 client_secret은 새로 만든 팀의 키 파일로 생성된 client_secret이다.</li>
<li>client_secret을 만드는 방법은 1번과 같다.</li>
<li>bearer token은 기존에 만든 것을 사용하면 된다.</li>
</ul>
</li>
</ol>
<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/7.png" class title="애플 팀 변경 시 유저 정보 migration하기">

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">URL : https://appleid.apple.com/auth/usermigrationinfo</span><br><span class="line">HTTP Method : POST</span><br><span class="line">Content-Type : x-www-form-urlencoded</span><br><span class="line">Authorization: Bearer &#123;access_token&#125;</span><br><span class="line">Body : </span><br><span class="line">&#123;</span><br><span class="line">    transfer_sub : 이전 단계에서 transfer된 sub</span><br><span class="line">    client_id : 클라이언트 아이디</span><br><span class="line">    client_secret : 새로 만든 팀의 client_secret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>요청 후 결과 확인</li>
</ol>
<img src="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/8.png" class title="애플 팀 변경 시 유저 정보 migration하기">

<ul>
<li>000000.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.0000</li>
<li>형식으로 생성되는데 이 때 맨 앞에 00000. 부분은 변경되지 않으므로</li>
<li>이 부분을 확인</li>
</ul>
<hr>
<h3 id="5-DB에-저장된-유저-provider-Id-변경"><a href="#5-DB에-저장된-유저-provider-Id-변경" class="headerlink" title="5. DB에 저장된 유저 provider Id 변경"></a>5. DB에 저장된 유저 provider Id 변경</h3><ul>
<li>필자의 서비스는 provider ID로 유니크한 KEY를 만들어 사용하고 있었으므로 이 부분을 업데이트 해주었다.</li>
</ul>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.apple.com/documentation/sign_in_with_apple/transferring_your_apps_and_users_to_another_team">https://developer.apple.com/documentation/sign_in_with_apple/transferring_your_apps_and_users_to_another_team</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.apple.com/documentation/sign_in_with_apple/bringing_new_apps_and_users_into_your_team">https://developer.apple.com/documentation/sign_in_with_apple/bringing_new_apps_and_users_into_your_team</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.apple.com/forums/thread/666734">https://developer.apple.com/forums/thread/666734</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/10/31/%EC%95%A0%ED%94%8C-%ED%8C%80-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EC%9C%A0%EC%A0%80-%EC%A0%95%EB%B3%B4-migration%ED%95%98%EA%B8%B0/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/09/12/Unable-to-locate-Attribute-with-the-the-given-name-XXX-on-this-ManagedType/" aria-label=": Unable to locate Attribute  with the the given name [XXX] on this ManagedType">
                            Unable to locate Attribute  with the the given name [XXX] on this ManagedType
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-09-12T16:02:14+09:00">
	
		    2021/09/12
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>spring으로 된 프로젝트를 spring boot으로 전환 중… query method로 작성되어 있는 부분에서 발생한 문제에 대해 알아보고 이에 대한 해결 방법을 정리 해둔다.</p>
<hr>
<h2 id="본론"><a href="#본론" class="headerlink" title="본론"></a>본론</h2><h3 id="에러가-발생한-code"><a href="#에러가-발생한-code" class="headerlink" title="에러가 발생한 code"></a>에러가 발생한 code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XXXX</span> </span>&#123;</span><br><span class="line">    ... </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DDay dDay;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Category&gt; <span class="title">findByDDayOrderByDDayStartDateAsc</span><span class="params">(DDay dday)</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h3 id="발생한-에러-전문"><a href="#발생한-에러-전문" class="headerlink" title="발생한 에러 전문"></a>발생한 에러 전문</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalArgumentException: Unable to locate Attribute  with the the given name [attribute명] on this ManagedType [class명]</span><br><span class="line">    at org.hibernate.metamodel.model.domain.internal.AbstractManagedType.checkNotNull(AbstractManagedType.java:<span class="number">148</span>) ~[hibernate-core-<span class="number">5.4</span>.<span class="number">32.F</span>inal.jar:<span class="number">5.4</span>.<span class="number">32.F</span>inal]</span><br><span class="line">    at org.hibernate.metamodel.model.domain.internal.AbstractManagedType.getAttribute(AbstractManagedType.java:<span class="number">119</span>) ~[hibernate-core-<span class="number">5.4</span>.<span class="number">32.F</span>inal.jar:<span class="number">5.4</span>.<span class="number">32.F</span>inal]</span><br><span class="line">    at org.hibernate.metamodel.model.domain.internal.AbstractManagedType.getAttribute(AbstractManagedType.java:<span class="number">44</span>) ~[hibernate-core-<span class="number">5.4</span>.<span class="number">32.F</span>inal.jar:<span class="number">5.4</span>.<span class="number">32.F</span>inal]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.QueryUtils.requiresOuterJoin(QueryUtils.java:<span class="number">697</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.QueryUtils.toExpressionRecursively(QueryUtils.java:<span class="number">638</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.QueryUtils.toExpressionRecursively(QueryUtils.java:<span class="number">617</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.QueryUtils.toExpressionRecursively(QueryUtils.java:<span class="number">613</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.JpaQueryCreator$PredicateBuilder.getTypedPath(JpaQueryCreator.java:<span class="number">385</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.JpaQueryCreator$PredicateBuilder.build(JpaQueryCreator.java:<span class="number">308</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.JpaQueryCreator.toPredicate(JpaQueryCreator.java:<span class="number">211</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.JpaQueryCreator.create(JpaQueryCreator.java:<span class="number">124</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.JpaQueryCreator.create(JpaQueryCreator.java:<span class="number">59</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.repository.query.parser.AbstractQueryCreator.createCriteria(AbstractQueryCreator.java:<span class="number">119</span>) ~[spring-data-commons-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.repository.query.parser.AbstractQueryCreator.createQuery(AbstractQueryCreator.java:<span class="number">95</span>) ~[spring-data-commons-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.repository.query.parser.AbstractQueryCreator.createQuery(AbstractQueryCreator.java:<span class="number">81</span>) ~[spring-data-commons-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.PartTreeJpaQuery$QueryPreparer.&lt;init&gt;(PartTreeJpaQuery.java:<span class="number">217</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.PartTreeJpaQuery$CountQueryPreparer.&lt;init&gt;(PartTreeJpaQuery.java:<span class="number">348</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    at org.springframework.data.jpa.repository.query.PartTreeJpaQuery.&lt;init&gt;(PartTreeJpaQuery.java:<span class="number">91</span>) ~[spring-data-jpa-<span class="number">2.5</span>.<span class="number">2.</span>jar:<span class="number">2.5</span>.<span class="number">2</span>]</span><br><span class="line">    ... <span class="number">117</span> common frames omitted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="왜-발생-했을까"><a href="#왜-발생-했을까" class="headerlink" title="왜 발생 했을까?"></a>왜 발생 했을까?</h3><blockquote><p>The inconsistency between the subject part and the OrderBy part is certainly a bug.</p>
<p>For the given case the correct behaviour  seem to be the one from the OrderBy part which is adhering to the conventions laid out in the Java Bean Specification 1.0.1 Section 8.8:</p>
<p>…</p>
<p>There is no way to write the property name in the middle of a java method name if the property begins with a single lower case letter followed by an upper case letter.</p>
<p>Therefore renaming the property, or less invasive providing a @Query annotation are the ways to solve this problem on your side GitFlip</p>
<footer><strong>spring-data-commons</strong><cite><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-data-commons/issues/1996">spring-projects</a></cite></footer></blockquote>

<br>

<p>독자들의 빠른 문제 해결을 위해 결론부터 이야기 하자면 위의 글에서 보는 것 처럼 query method에서 OrderBy를 사용 할 때 “dDay” 같이 맨 앞 한 자리가 소문자 변수명을 사용 하는 경우  spring-data-jpa의 버그로 발생하는 에러인데 해결방법으로는 @Query annotation을 사용하거나 변수명을 변경하는 것을 권하고 있다.</p>
<hr>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><h3 id="해결-방법"><a href="#해결-방법" class="headerlink" title="해결 방법"></a>해결 방법</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(&quot;SELECT c FROM Entity명 c WHERE c.dDay =:dday ORDER BY dDayStartDate&quot;)</span></span><br><span class="line"><span class="function">List&lt;Category&gt; <span class="title">findByDDayOrderByDDayStartDateAsc</span><span class="params">(DDay dday)</span></span>;</span><br></pre></td></tr></table></figure>

<p>위에서 알려준 해결책 중 필자는 @Query Annotation을 사용하는 방법으로 문제를 수정하였는데 다른 이유가 있는 것은 아니고 현재 프로젝트에서 변수명을 변경하는 것이 더 코스트가 많이 발생하기 때문에 @Query를 사용해서 처리했다.</p>
<p>이 문제 때문에 꽤 많은 시간을 소비 하였는데 필자와 같은 무고한 피해자(?)가 발생하지 않기를 바라며 글을 마친다.</p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-property-expressions">https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-property-expressions</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://hongsii.github.io/2019/01/06/jpa-query-creation-with-underscore/">https://hongsii.github.io/2019/01/06/jpa-query-creation-with-underscore/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spring-projects/spring-data-commons/issues/1996">https://github.com/spring-projects/spring-data-commons/issues/1996</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/09/12/Unable-to-locate-Attribute-with-the-the-given-name-XXX-on-this-ManagedType/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/08/01/Attribute-ifAnyGranted-invalid-for-tag-authorize-according-to-TLD/" aria-label=": Attribute [ifAnyGranted] invalid for tag [authorize] according to TLD">
                            Attribute [ifAnyGranted] invalid for tag [authorize] according to TLD
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-08-01T18:18:55+09:00">
	
		    2021/08/01
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="상황"><a href="#상황" class="headerlink" title="상황"></a>상황</h2><p>spring으로 된 프로젝트를 spring boot으로 전환 중에 spring-security-taglibs의 버전을 3.x 에서 5.5.1로 업데이트 했는데 아래와 같은 에러가 발생하여 이에 관한 내용을 정리 해둔다.</p>
<hr>
<h2 id="발생한-에러"><a href="#발생한-에러" class="headerlink" title="발생한 에러"></a>발생한 에러</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">org.apache.jasper.JasperException: /WEB-INF/views/layout/layout.jsp (line: [<span class="number">126</span>], column: [<span class="number">0</span>]) Attribute [ifAnyGranted] invalid <span class="keyword">for</span> tag [authorize] according to TLD</span><br><span class="line">        at org.apache.jasper.compiler.DefaultErrorHandler.jspError(DefaultErrorHandler.java:<span class="number">41</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.ErrorDispatcher.dispatch(ErrorDispatcher.java:<span class="number">292</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.ErrorDispatcher.jspError(ErrorDispatcher.java:<span class="number">115</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Validator$ValidateVisitor.checkXmlAttributes(Validator.java:<span class="number">1287</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Validator$ValidateVisitor.visit(Validator.java:<span class="number">900</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Node$CustomTag.accept(Node.java:<span class="number">1558</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Node$Nodes.visit(Node.java:<span class="number">2385</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Node$Visitor.visitBody(Node.java:<span class="number">2437</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Node$Visitor.visit(Node.java:<span class="number">2443</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Node$Root.accept(Node.java:<span class="number">471</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line">        at org.apache.jasper.compiler.Node$Nodes.visit(Node.java:<span class="number">2385</span>) ~[tomcat-embed-jasper-<span class="number">9.0</span>.<span class="number">48.</span>jar!/:na]</span><br><span class="line"></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<h2 id="왜-발생했을까"><a href="#왜-발생했을까" class="headerlink" title="왜 발생했을까?"></a>왜 발생했을까?</h2><blockquote><p>This section describes all of the deprecated APIs within the spring-security-taglibs module. If you are not using the spring-security-taglibs module or have already completed this task, you can safely skip to spring-security-web.</p>
<p>Spring Security’s authorize JSP tag deprecated the properties ifAllGranted, ifAnyGranted, and ifNotGranted in favor of using expressions.</p>
<footer><strong>spring-security,</strong><cite><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-security/site/migrate/current/3-to-4/html5/migrate-3-to-4-jc.html#m3to4-deprecations-taglibs">Migrating from Spring Security 3.x to 4.x</a></cite></footer></blockquote>


<p>문서에 적혀 있는 것 처럼 spring-security-taglibs 4.x 버전 이상 부터는 ifAllGranted, ifAnyGranted, ifNotGranted 속성들을 지원하지 않기 때문에 3.x 버전에서 5 버전으로 업그레이드하면서 해당 속성들을 사용한 코드들이 있는 경우 발생하는 문제였다.</p>
<h2 id="해결방법"><a href="#해결방법" class="headerlink" title="해결방법"></a>해결방법</h2><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;sec:authorize ifAllGranted=<span class="string">&quot;ROLE_ADMIN,ROLE_USER&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;Must have ROLE_ADMIN and ROLE_USER&lt;/p&gt;</span><br><span class="line">&lt;/sec:authorize&gt;</span><br><span class="line">&lt;sec:authorize ifAnyGranted=<span class="string">&quot;ROLE_ADMIN,ROLE_USER&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;Must have ROLE_ADMIN or ROLE_USER&lt;/p&gt;</span><br><span class="line">&lt;/sec:authorize&gt;</span><br><span class="line">&lt;sec:authorize ifNotGranted=<span class="string">&quot;ROLE_ADMIN,ROLE_USER&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;Must not have ROLE_ADMIN or ROLE_USER&lt;/p&gt;</span><br><span class="line">&lt;/sec:authorize&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>위 처럼 되어 있을 경우</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;sec:authorize access=<span class="string">&quot;hasRole(&#x27;ROLE_ADMIN&#x27;) and hasRole(&#x27;ROLE_USER&#x27;)&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;Must have ROLE_ADMIN and ROLE_USER&lt;/p&gt;</span><br><span class="line">&lt;/sec:authorize&gt;</span><br><span class="line">&lt;sec:authorize access=<span class="string">&quot;hasAnyRole(&#x27;ROLE_ADMIN&#x27;,&#x27;ROLE_USER&#x27;)&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;Must have ROLE_ADMIN or ROLE_USER&lt;/p&gt;</span><br><span class="line">&lt;/sec:authorize&gt;</span><br><span class="line">&lt;sec:authorize access=<span class="string">&quot;!hasAnyRole(&#x27;ROLE_ADMIN&#x27;,&#x27;ROLE_USER&#x27;)&quot;</span>&gt;</span><br><span class="line">    &lt;p&gt;Must not have ROLE_ADMIN or ROLE_USER&lt;/p&gt;</span><br><span class="line">&lt;/sec:authorize&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>아래 처럼 치환해주면 정상적으로 작동하는 것을 확인 할 수 있을 것이다.</p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://okky.kr/article/679832">https://okky.kr/article/679832</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.spring.io/spring-security/site/migrate/current/3-to-4/html5/migrate-3-to-4-jc.html#m3to4-deprecations-taglibs">https://docs.spring.io/spring-security/site/migrate/current/3-to-4/html5/migrate-3-to-4-jc.html#m3to4-deprecations-taglibs</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/08/01/Attribute-ifAnyGranted-invalid-for-tag-authorize-according-to-TLD/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/05/30/Command-line-is-too-long-Shorten-command-line-for-%ED%95%B4%EA%B2%B0/" aria-label=": Command line is too long. Shorten command line for.. 해결">
                            Command line is too long. Shorten command line for.. 해결
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-30T11:48:52+09:00">
	
		    2021/05/30
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="상황"><a href="#상황" class="headerlink" title="상황"></a>상황</h2><p>평소와 같이 테스트 코드를 작성하고 실행을 했는데… 아래와 같이 에러가 발생하며 테스트가 진행되지 않았다.</p>
<h3 id="발생한-에러"><a href="#발생한-에러" class="headerlink" title="발생한 에러"></a>발생한 에러</h3><img src="/2021/05/30/Command-line-is-too-long-Shorten-command-line-for-%ED%95%B4%EA%B2%B0/%EC%97%90%EB%9F%AC.JPG" class title="Command line is too long. Shorten command line for.. 해결">

<hr>
<h2 id="해결"><a href="#해결" class="headerlink" title="해결"></a>해결</h2><img src="/2021/05/30/Command-line-is-too-long-Shorten-command-line-for-%ED%95%B4%EA%B2%B0/workspace.JPG" class title="Command line is too long. Shorten command line for.. 해결">

<p>위 이미지처럼 프로젝트 루트에 존재하는 .idea 폴더에 workspace.xml 파일을 열어서</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;PropertiesComponent&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dynamic.classpath&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>를 추가해주면 된다.</p>
<p>보통 이미 PropertiesComponent 태그는 존재 할 테니 그 아래 있는</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dynamic.classpath&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>옵션만 정상적으로 넣어주면 된다.</p>
<hr>
<h2 id="보너스"><a href="#보너스" class="headerlink" title="보너스"></a>보너스</h2><h3 id="dynamic-classpath-옵션이-뭔데-넣으면-되는-거에요"><a href="#dynamic-classpath-옵션이-뭔데-넣으면-되는-거에요" class="headerlink" title="dynamic.classpath 옵션이 뭔데 넣으면 되는 거에요?"></a>dynamic.classpath 옵션이 뭔데 넣으면 되는 거에요?</h3><p>이 질문에 대한 답은 역시 없는게 없는 스택오버 플로우에 이미 존재한다. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://stackoverflow.com/questions/4853540/what-does-the-dynamic-classpath-flag-do-intellij-project-settings">What does the dynamic.classpath flag do? (IntelliJ project settings)</a></p>
<p>간단하게 정리하면 커맨드라인이나 파일을 통해 클래스 패스가 jvm에 전달되는 방식을 제어하는데 대부분의 os에선 최대 명령 줄 제한이 있어서 이 제한을 넘는 명령은 IDEA에서 실행 할 수 없기 때문에 명령이 32768 자 보다 길면 동적 클래스 패스로 전환 할 것을 제안하고 이 때 긴~ 클래스 패스는 파일에 기록된 다음, 응용 프로그램 관리자가 읽어서 시스템 클래스 로더를 통해 로드 된다는 것이다.</p>
<p>끝!</p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://stackoverflow.com/questions/4853540/what-does-the-dynamic-classpath-flag-do-intellij-project-settings">https://stackoverflow.com/questions/4853540/what-does-the-dynamic-classpath-flag-do-intellij-project-settings</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://jmlim.github.io/intellij/2020/02/27/intellij-idea-command-line-is-too-long-error/">http://jmlim.github.io/intellij/2020/02/27/intellij-idea-command-line-is-too-long-error/</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/05/30/Command-line-is-too-long-Shorten-command-line-for-%ED%95%B4%EA%B2%B0/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/05/03/Android-Button-tag-AppCompat-Error/" aria-label=": Android Button tag AppCompat Error">
                            Android Button tag AppCompat Error
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-03T21:54:53+09:00">
	
		    2021/05/03
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>어쩌다보니 학부생 시절 가장 싫어해 마지않던 안드로이드를 다시 공부하게 되었는데, 간단한 화면 하나 만들고도 실행이 안되서 삽질한 내용을 정리한다.</p>
<hr>
<h2 id="발생한-에러"><a href="#발생한-에러" class="headerlink" title="발생한 에러"></a>발생한 에러</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">05</span>-<span class="number">03</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">26.170</span> <span class="number">18752</span>-<span class="number">18752</span>/com.jgji.memo E/AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line">    Process: com.jgji.memo, PID: <span class="number">18752</span></span><br><span class="line">    java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;com.jgji.memo/com.jgji.memo.MainActivity&#125;: android.view.InflateException: Binary XML file line #33 in com.jgji.memo:layout/activity_main: Binary XML file line #33 in com.jgji.memo:layout/activity_main: Error inflating class Button</span><br><span class="line">        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:<span class="number">3449</span>)</span><br><span class="line">        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:<span class="number">3601</span>)</span><br><span class="line">        at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:<span class="number">85</span>)</span><br><span class="line">        at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:<span class="number">135</span>)</span><br><span class="line">        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">95</span>)</span><br><span class="line">        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2066</span>)</span><br><span class="line">        at android.os.Handler.dispatchMessage(Handler.java:<span class="number">106</span>)</span><br><span class="line">        at android.os.Looper.loop(Looper.java:<span class="number">223</span>)</span><br><span class="line">        at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7656</span>)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">592</span>)</span><br><span class="line">        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">947</span>)</span><br><span class="line">     Caused by: android.view.InflateException: Binary XML file line #33 in com.jgji.memo:layout/activity_main: Binary XML file line #33 in com.jgji.memo:layout/activity_main: Error inflating class Button</span><br><span class="line">     Caused by: android.view.InflateException: Binary XML file line #33 in com.jgji.memo:layout/activity_main: Error inflating class Button</span><br><span class="line">     Caused by: java.lang.IllegalArgumentException: The style on <span class="keyword">this</span> component <span class="keyword">requires</span> your app theme to be Theme.AppCompat (or a descendant).</span><br><span class="line">        at com.google.android.material.internal.ThemeEnforcement.checkTheme(ThemeEnforcement.java:<span class="number">243</span>)</span><br><span class="line">        at com.google.android.material.internal.ThemeEnforcement.checkAppCompatTheme(ThemeEnforcement.java:<span class="number">213</span>)</span><br><span class="line">        at com.google.android.material.internal.ThemeEnforcement.checkCompatibleTheme(ThemeEnforcement.java:<span class="number">148</span>)</span><br><span class="line">        at com.google.android.material.internal.ThemeEnforcement.obtainStyledAttributes(ThemeEnforcement.java:<span class="number">76</span>)</span><br><span class="line">        at com.google.android.material.button.MaterialButton.&lt;init&gt;(MaterialButton.java:<span class="number">229</span>)</span><br><span class="line">        at com.google.android.material.button.MaterialButton.&lt;init&gt;(MaterialButton.java:<span class="number">220</span>)</span><br><span class="line">        at com.google.android.material.theme.MaterialComponentsViewInflater.createButton(MaterialComponentsViewInflater.java:<span class="number">43</span>)</span><br><span class="line">        at androidx.appcompat.app.AppCompatViewInflater.createView(AppCompatViewInflater.java:<span class="number">123</span>)</span><br><span class="line">        at androidx.appcompat.app.AppCompatDelegateImpl.createView(AppCompatDelegateImpl.java:<span class="number">1551</span>)</span><br><span class="line">        at androidx.appcompat.app.AppCompatDelegateImpl.onCreateView(AppCompatDelegateImpl.java:<span class="number">1602</span>)</span><br><span class="line">        at android.view.LayoutInflater.tryCreateView(LayoutInflater.java:<span class="number">1059</span>)</span><br><span class="line">        at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:<span class="number">995</span>)</span><br><span class="line">        at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:<span class="number">959</span>)</span><br><span class="line">        at android.view.LayoutInflater.rInflate(LayoutInflater.java:<span class="number">1121</span>)</span><br><span class="line">        at android.view.LayoutInflater.rInflateChildren(LayoutInflater.java:<span class="number">1082</span>)</span><br><span class="line">        at android.view.LayoutInflater.inflate(LayoutInflater.java:<span class="number">680</span>)</span><br><span class="line">        at android.view.LayoutInflater.inflate(LayoutInflater.java:<span class="number">532</span>)</span><br><span class="line">        at android.view.LayoutInflater.inflate(LayoutInflater.java:<span class="number">479</span>)</span><br><span class="line">        at androidx.appcompat.app.AppCompatDelegateImpl.setContentView(AppCompatDelegateImpl.java:<span class="number">696</span>)</span><br><span class="line">        at androidx.appcompat.app.AppCompatActivity.setContentView(AppCompatActivity.java:<span class="number">170</span>)</span><br><span class="line">        at com.jgji.memo.MainActivity.onCreate(MainActivity.java:<span class="number">27</span>)</span><br><span class="line">        at android.app.Activity.performCreate(Activity.java:<span class="number">8000</span>)</span><br><span class="line">        at android.app.Activity.performCreate(Activity.java:<span class="number">7984</span>)</span><br><span class="line">        at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:<span class="number">1309</span>)</span><br><span class="line">        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:<span class="number">3422</span>)</span><br><span class="line">        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:<span class="number">3601</span>)</span><br><span class="line">        at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:<span class="number">85</span>)</span><br></pre></td></tr></table></figure>

<h2 id="해결"><a href="#해결" class="headerlink" title="해결"></a>해결</h2><p>결론부터 바로 말하면</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint(value = &quot;StaticFieldLeak&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MemoDatabase db;</span><br><span class="line">    <span class="keyword">private</span> List&lt;MemoEntity&gt; memoList;</span><br><span class="line">    <span class="keyword">private</span> RecyclerView recyclerView;</span><br><span class="line">    <span class="keyword">private</span> MemoDAO memoDAO;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>되어 있던 코드를 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatActivity">AppCompatActivity</a> 말고 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.android.com/reference/android/app/Activity.html?hl=ko">Activity</a>를 상속 받도록 변경해서 해결 했다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint(value = &quot;StaticFieldLeak&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MemoDatabase db;</span><br><span class="line">    <span class="keyword">private</span> List&lt;MemoEntity&gt; memoList;</span><br><span class="line">    <span class="keyword">private</span> RecyclerView recyclerView;</span><br><span class="line">    <span class="keyword">private</span> MemoDAO memoDAO;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="여담"><a href="#여담" class="headerlink" title="여담"></a>여담</h2><p>둘의 정확한 차이는 모르겠지만, AppCompatActivity가 이전 안드로이드버전까지 커버해주는 클래스이고, Activity는 최신버전만 지원한다고 하는데… 이 문제랑 무슨 상관이 있는지 필자의 좁은 식견으로는 알 수가 없었기에 문제 해결에 도움을 받은 스택오버플로우의 글을 링크하며 글을 마무리 한다.  <a target="_blank" rel="external nofollow noopener noreferrer" href="https://stackoverflow.com/questions/21814825/you-need-to-use-a-theme-appcompat-theme-or-descendant-with-this-activity">You need to use a Theme.AppCompat theme (or descendant) with this activity</a></p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatActivity">https://developer.android.com/reference/androidx/appcompat/app/AppCompatActivity</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.android.com/reference/android/app/Activity.html?hl=ko">https://developer.android.com/reference/android/app/Activity.html?hl=ko</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://stackoverflow.com/questions/21814825/you-need-to-use-a-theme-appcompat-theme-or-descendant-with-this-activity">https://stackoverflow.com/questions/21814825/you-need-to-use-a-theme-appcompat-theme-or-descendant-with-this-activity</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/05/03/Android-Button-tag-AppCompat-Error/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
            <a href="/2021/05/03/Android-Button-tag-AppCompat-Error/" aria-label=": Android Button tag AppCompat Error">
                <div class="postShorten-thumbnailimg">
                    <img alt src>
                </div>
            </a>
            
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2021/04/30/mysqldump%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-MySQL-backup/" aria-label=": mysqldump를 활용한 MySQL backup">
                            mysqldump를 활용한 MySQL backup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-04-30T23:02:05+09:00">
	
		    2021/04/30
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>평소와 다름없이 유튜브를 배회하던 중 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.youtube.com/watch?v=SWZcrdmmLEU">재난급 서버 장애내고 개발자 인생 끝날뻔 한 썰</a>이란 영상을 보게 되었는데… ‘나는 지금 어떻게 하고 있지..?’ 라는 생각이 문득 들어서 얼른 나도 백업을 수시로 해둬야겠다는 생각에 적용한 mysql backup 방법을 남겨둔다.</p>
<hr>
<h2 id="왜-mysqldump로-했어요"><a href="#왜-mysqldump로-했어요" class="headerlink" title="왜 mysqldump로 했어요??"></a>왜 mysqldump로 했어요??</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html">mysqldump</a>는 스토리지 엔진에 관계없이 논리 백업을 수행 할 수 있는 도구다.<br>무엇을 이용해서 backup을 해야할까 고민 하던 중 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://woowabros.github.io/experience/2018/05/28/billingjul.html">장애와 관련된 XtraBackup 적용기</a>를 보게 되었는데<br>데이터 사이즈가 크지 않다면 mysqldump를 사용하는 것이 간단하며 복원 시에도 신경 써야 할 것이 적다는 내용을 보고 mysqldump로 backup을 진행하기로 결정했다.</p>
<h2 id="그럼-어떻게-해요"><a href="#그럼-어떻게-해요" class="headerlink" title="그럼 어떻게 해요??"></a>그럼 어떻게 해요??</h2><p>mysqldump엔 여러가지 옵션들이 있지만 그 중 필자는 아래 처럼 사용 했다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --single-transaction --databases [db명] --tables [테이블명] -h [db주소] -u [username] -p | gzip &gt; [파일명].gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mysqldump-option"><a href="#mysqldump-option" class="headerlink" title="mysqldump option"></a>mysqldump option</h3><ul>
<li>–single-transaction : lock 을 걸지 않고도 dump 파일의 정합성 보장하는데 InnoDB 테이블이 아닌 MyISAM or MEMORY 테이블인 경우에는 여전히 상태가 변경 될 수 있다.<br>MySQL에선 큰 테이블을 덤프하려면 –quick 옵션과 결합하기를 권장한다.</li>
<li>–databases : dump 할 db명을 지정한다. 여러 개를 한번에 지정하는 것도 가능하다.</li>
<li>–tables : dump 할 table명을 지정한다. 마찬가지로 여러 개를 한번에 지정 할 수 있다.</li>
</ul>
<p>그리고 필자는 테이블 별로 데이터를 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://zetawiki.com/wiki/%EB%A6%AC%EB%88%85%EC%8A%A4_gzip">gzip 형식</a>으로 압축하기 위해 gzip 명령어를 사용했다.</p>
<h3 id="그-결과"><a href="#그-결과" class="headerlink" title="그 결과"></a>그 결과</h3><img src="/2021/04/30/mysqldump%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-MySQL-backup/%EA%B7%B8_%EA%B2%B0%EA%B3%BC.png" class title="mysqldump를 활용한 MySQL backup mysqldump 실행 결과 mysqldump 실행 결과">

<p>명령어를 실행하면 이 처럼 해당 경로에 .gz로 압축된 파일이 생성되고 이 파일의 압축을 해제하면 sql 파일이 된다.</p>
<h3 id="예외-상황"><a href="#예외-상황" class="headerlink" title="예외 상황"></a>예외 상황</h3><p>mysqldump는 mysql  client 유틸리티 이므로 당연히 mysql client가 있어야 실행 가능한데 아래 메시지는 그 mysql client가 설치되지 않았으니 설치 한 후 사용하라는 메시지이다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The program &#x27;mysqldump&#x27; can be found in the following packages:</span><br><span class="line"> * mysql-client-5.5</span><br><span class="line"> * mariadb-client-5.5</span><br><span class="line"> * mysql-client-5.6</span><br><span class="line"> * percona-xtradb-cluster-client-5.5</span><br><span class="line">Try: sudo apt-get install &lt;selected package&gt;</span><br></pre></td></tr></table></figure>

<p>이 처럼 메시지가 출력 될 경우 위 리스트 중 하나를 설치하면 정상적으로 mysqldump가 이용 가능해 질 것이다.</p>
<hr>
<h2 id="shell-script로-작성하기"><a href="#shell-script로-작성하기" class="headerlink" title="shell script로 작성하기"></a>shell script로 작성하기</h2><p>이제 이 명령어를 스케줄러에 등록하기 위해 우선 쉘 스크립트 파일로 작성해야 하는데 필자 같은 경우는 아래와 같이 작성해서 사용하고 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">HOST=host명</span><br><span class="line">USER=user명</span><br><span class="line">PASSWORD=password</span><br><span class="line">DATABASE=db명</span><br><span class="line">TABLES=(</span><br><span class="line">table1</span><br><span class="line">table2</span><br><span class="line">table3</span><br><span class="line">...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">TABLES_STRING=&#x27;&#x27;</span><br><span class="line">for TABLE in &quot;$&#123;TABLES[@]&#125;&quot;</span><br><span class="line">do :</span><br><span class="line">   sudo mysqldump --single-transaction --databases $&#123;DATABASE&#125; --tables $&#123;TABLE&#125; --host $&#123;HOST&#125; --user $&#123;USER&#125; --password $&#123;PASSWORD&#125; | gzip &gt; /home/backup/$&#123;TABLE&#125;.sql.gz</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>이렇게 작성한 sh 파일을 bash 명령어로 실행하면 테이블 갯수만큼 비밀번호를 입력하면 백업 작업을 정상적으로 완료하게 된다… (정말?)</p>
<hr>
<h2 id="crontab을-자동-backup"><a href="#crontab을-자동-backup" class="headerlink" title="crontab을 자동 backup"></a>crontab을 자동 backup</h2><p>이제 백업을 자동으로 실행하게 하기 위해서 리눅스에 존재하는 <a href="%5Bhttps://zetawiki.com/wiki/%EB%A6%AC%EB%88%85%EC%8A%A4_%EB%B0%98%EB%B3%B5_%EC%98%88%EC%95%BD%EC%9E%91%EC%97%85_cron,_crond,_crontab%5D(https://zetawiki.com/wiki/%EB%A6%AC%EB%88%85%EC%8A%A4_%EB%B0%98%EB%B3%B5_%EC%98%88%EC%95%BD%EC%9E%91%EC%97%85_cron,_crond,_crontab)">crontab</a>을 이용하기로 한다.</p>
<h3 id="crontab-등록-방법"><a href="#crontab-등록-방법" class="headerlink" title="crontab 등록 방법"></a>crontab 등록 방법</h3><p>리눅스 서버에 접속해서</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br></pre></td></tr></table></figure>

<p>명령어를 실행하면 아래 처럼 <strong>해당 유저</strong>로 서버에 등록된 스케줄들이 보이게 되는데 해당 유저로 등록된 서비스가 없다면 아래 처럼</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user명@ip-127.0.0.1:~$ crontab -l</span><br><span class="line">no crontab for user명</span><br></pre></td></tr></table></figure>

<p>메시지가 출력되고 해당 유저로 등록된 서버스가 존재 할 경우엔</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">user명@ip-127.0.0.1:~$ crontab -l</span><br><span class="line"><span class="meta">#</span><span class="bash"> Edit this file to introduce tasks to be run by cron.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Each task to run has to be defined through a single line</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> indicating with different fields when the task will be run</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and what <span class="built_in">command</span> to run <span class="keyword">for</span> the task</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> To define the time you can provide concrete values <span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> minute (m), hour (h), day of month (dom), month (mon),</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and day of week (dow) or use <span class="string">&#x27;*&#x27;</span> <span class="keyword">in</span> these fields (<span class="keyword">for</span> <span class="string">&#x27;any&#x27;</span>).<span class="comment"># </span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Notice that tasks will be started based on the cron<span class="string">&#x27;s system</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> daemon<span class="string">&#x27;s notion of time and timezones.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Output of the crontab <span class="built_in">jobs</span> (including errors) is sent through</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> email to the user the crontab file belongs to (unless redirected).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For example, you can run a backup of all your user accounts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> at 5 a.m every week with:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For more information see the manual pages of crontab(5) and cron(8)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> m h  dom mon dow   <span class="built_in">command</span></span></span><br><span class="line">10 04 * * * bash 백업 실행 파일.sh</span><br></pre></td></tr></table></figure>

<p>위 처럼 cat 명령어를 실행 한 것 처럼 콘솔에 crontab의 내용이 보여지게 된다.<br>이렇게 저장된 스케줄러들을 확인난 후에</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>

<p>명령어를 통해 스케줄러를 등록하면 되는데 이 때 crontab -e 명령어를 실행시키면 crontab을 열 텍스트 에디터를 선택하라는 메시지가 출력되거나, 디폴트로 지정된 텍스트 에디터로 crontab이 열리게 된다.</p>
<p>어떤 식이든 crontab이 열리면</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* * * * *  수행할 명령어</span><br><span class="line">┬ ┬ ┬ ┬ ┬</span><br><span class="line">│ │ │ │ │</span><br><span class="line">│ │ │ │ │</span><br><span class="line">│ │ │ │ └───────── 요일 (0 - 6) (0:일요일, 1:월요일, 2:화요일, …, 6:토요일)</span><br><span class="line">│ │ │ └───────── 월 (1 - 12)</span><br><span class="line">│ │ └───────── 일 (1 - 31)</span><br><span class="line">│ └───────── 시 (0 - 23)</span><br><span class="line">└───────── 분 (0 - 59)</span><br></pre></td></tr></table></figure>

<p>위 형식에 맞춰 언제마다 실행 시킬 지 정한 후 우리가 만든 backup용 sh 파일을 실행하게 하면 된다.</p>
<p>필자는 매일 04시 10분에 실행 시키기 위해 아래와 같이 작성하여 등록했다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10 04 * * * bash 백업 실행 파일.sh</span><br></pre></td></tr></table></figure>

<p>이렇게 작성하고 테스트를 하기 위해 date 명령어로 서버 시간을 확인한 후 실행 시간을 현재 시간에서 2분 뒤로 변경하여 2분 뒤에 실행하게 하였는데…</p>
<hr>
<h2 id="왜-백업이-안되지…"><a href="#왜-백업이-안되지…" class="headerlink" title="왜 백업이 안되지…?"></a>왜 백업이 안되지…?</h2><img src="/2021/04/30/mysqldump%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-MySQL-backup/%EB%B0%B1%EC%97%85%EC%8B%A4%ED%8C%A8.png" class title="mysqldump를 활용한 MySQL backup 뎃? 어쨰서 파일 사이즈가...? 뎃? 어쨰서 파일 사이즈가...?">

<p>이미지에서 보이는 것 처럼 파일 사이즈가 20 바이트 밖에 안되길래 확인해보니 백업이 정상적으로 이루어지지 않은 것 이었다.</p>
<p>왜 이렇게 됐을까를 고민하던 중… 스케줄러에 등록하기 전 sh파일을 단독으로 실행 했을 때 table 갯수만큼 비밀번호를 입력했던 것이 떠올라서 그 부분이 문제일 것이라고 판단되어 찾아보니 <a href="%5Bhttps://dev.mysql.com/doc/refman/8.0/en/password-security-user.html%5D(https://dev.mysql.com/doc/refman/8.0/en/password-security-user.html)">공식 문서</a>에서 아래와 같은 글을 확인 할 수 있었다.</p>
<blockquote><p>Use the –password or -p option on the command line with no password value specified. In this case, the client program solicits the password interactively:</p>
<p>shell&gt; mysql -u francis -p db_name<br>Enter password: <strong>****</strong><br>The * characters indicate where you enter your password. The password is not displayed as you enter it.</p>
<p>It is more secure to enter your password this way than to specify it on the command line because it is not visible to other users. However, this method of entering a password is suitable only for programs that you run interactively. If you want to invoke a client from a script that runs noninteractively, there is no opportunity to enter the password from the keyboard. On some systems, you may even find that the first line of your script is read and interpreted (incorrectly) as your password.</p>
<footer><strong>Seth Godin</strong><cite><a target="_blank" rel="external nofollow noopener noreferrer" href="https://dev.mysql.com/doc/refman/8.0/en/password-security-user.html">6.1.2.1 End-User Guidelines for Password Security</a></cite></footer></blockquote>

<p>정리하면 —password 옵션은 클라이언트에 대화식으로 암호를 요청하고, 이 경우 비대화형으로 실행되는 스크립트에서 클라이언트를 호출 할 경우 암호를 입력 할 기회가 없으므로 일부 시스템에서 잘못 해석 될 수도 있다는 내용이었다.</p>
<h3 id="그래서-어떻게-해야되요…"><a href="#그래서-어떻게-해야되요…" class="headerlink" title="그래서 어떻게 해야되요…"></a>그래서 어떻게 해야되요…</h3><p>공식 문서를 보면 .my.cnf파일을 만들어서 거기에</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">password=password</span><br></pre></td></tr></table></figure>

<p>아래와 같은 형식으로 지정하고 안전을 위해 파일의 엑서스 모드를 400 또는, 600으로 설정하라고 한다.</p>
<p>그 후 mysqldump에서 지정한 설정 파일을 읽어들이게 하기 위해</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">shell&gt;</span><span class="bash"> mysql --defaults-file=/home/francis/mysql-opts</span></span><br></pre></td></tr></table></figure>

<p>처럼 파일의 전체 경로를 지정하라고 설명하고 있다.</p>
<h3 id="바뀐-sh파일-내용"><a href="#바뀐-sh파일-내용" class="headerlink" title="바뀐 sh파일 내용"></a>바뀐 sh파일 내용</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">HOST=host명</span><br><span class="line">USER=user명</span><br><span class="line">DATABASE=db명</span><br><span class="line">TABLES=(</span><br><span class="line">table1</span><br><span class="line">table2</span><br><span class="line">table3</span><br><span class="line">...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">TABLES_STRING=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> TABLE <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;TABLES[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span> :</span><br><span class="line">   sudo mysqldump --single-transaction --databases <span class="variable">$&#123;DATABASE&#125;</span> --tables <span class="variable">$&#123;TABLE&#125;</span> --host <span class="variable">$&#123;HOST&#125;</span> --user <span class="variable">$&#123;USER&#125;</span> | gzip &gt; /home/backup/<span class="variable">$&#123;TABLE&#125;</span>.sql.gz</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>—password 옵션을 제외하고 password가 my.cnf 설정파일에 들어갔으므로 최종적인 sh 파일 내용은 위와 같이 된다.</p>
<h2 id="결과"><a href="#결과" class="headerlink" title="결과"></a>결과</h2><img src="/2021/04/30/mysqldump%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-MySQL-backup/%EC%84%B1%EA%B3%B5.png" class title="mysqldump를 활용한 MySQL backup 성공, 대성공! 성공, 대성공!">

<p>모든 난관을 극복하고 다시 crontab -e에 등록해서 스케줄을 실행한 결과 위와 같이 정상적으로 백업을 완료하여 파일 사이즈가 아까와 다르게 20 byte가 아닌 모습을 볼 수 있다.</p>
<hr>
<h2 id="P-S-저는-그래도-안되는데요…"><a href="#P-S-저는-그래도-안되는데요…" class="headerlink" title="P.S : 저는 그래도 안되는데요…?"></a>P.S : 저는 그래도 안되는데요…?</h2><p>필자의 경우에도 .my.cnf 파일을 생성하고 등록해줬음에도 불구하고 백업이 정상적으로 진행되지 않았는데 결국 찾은 해결 방법은 .my.cnf 파일을 따로 생성하지 않고, 아래와 같이 /etc/mysql/my.cnf 파일에 password를 추가하는 방법으로 해결 했다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> One can use all long options that the program supports.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Run program with --<span class="built_in">help</span> to get a list of available options and with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --print-defaults to see <span class="built_in">which</span> it would actually understand and use.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For explanations see</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://dev.mysql.com/doc/mysql/en/server-system-variables.html</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This will be passed to all mysql clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It has been reported that passwords should be enclosed with ticks/quotes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> escpecially <span class="keyword">if</span> they contain <span class="string">&quot;#&quot;</span> chars...</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Remember to edit /etc/mysql/debian.cnf when changing the socket location.</span></span><br><span class="line">[client]</span><br><span class="line">port		= 3306</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">password        = password # !!! 이 부분 !!!</span><br><span class="line"><span class="meta">#</span><span class="bash"> Here is entries <span class="keyword">for</span> some specific programs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following values assume you have at least 32M ram</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This was formally known as [safe_mysqld]. Both versions are currently parsed.</span></span><br><span class="line">[mysqld_safe]</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">nice		= 0</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>필자와 같은 경우도 아니라면… 행운을 빈다…</p>
<hr>
<h2 id="참고-사이트"><a href="#참고-사이트" class="headerlink" title="참고 사이트"></a>참고 사이트</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html">MySQL 공식 사이트 mysqldump document</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://woowabros.github.io/experience/2018/05/28/billingjul.html">우아한 형제들 기술 블로그 - 장애와 관련된 XtraBackup 적용기</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.lesstif.com/dbms/mysqldump-db-backup-load-17105804.html">mysqldump 사용법(db backup 및 load 하기)</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://musma.github.io/2019/02/12/mysql-dump-and-import.html">MySQL 데이터 dump(Export)/Import 하기</a></li>
<li><a href="%5Bhttps://tableplus.com/blog/2018/08/mysql-how-to-dump-database-ignore-tables-or-data-with-mysqldump.html%5D(https://tableplus.com/blog/2018/08/mysql-how-to-dump-database-ignore-tables-or-data-with-mysqldump.html)">How to dump database and ignore some tables with mysqldump?</a></li>
<li><a href="%5Bhttps://dev.mysql.com/doc/refman/8.0/en/password-security-user.html%5D(https://dev.mysql.com/doc/refman/8.0/en/password-security-user.html)">End-User Guidelines for Password Security</a></li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a href="/2021/04/30/mysqldump%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-MySQL-backup/#post-footer" class="postShorten-excerpt_link link" aria-label>
                                댓글 공유
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
            <a href="/2021/04/30/mysqldump%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-MySQL-backup/" aria-label=": mysqldump를 활용한 MySQL backup">
                <div class="postShorten-thumbnailimg">
                    <img alt src>
                </div>
            </a>
            
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="/archives/" aria-label="최근 포스트">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span>최근 포스트</span>
            </a>
          </li>
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/archives/page/3/" aria-label="이전 포스트">
              <span>이전 포스트</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">page 2 of 11</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Junggu Ji. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">Junggu Ji</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-fvy43rs4ns3qkm3cliupi5qtnm0vwph13v4ev99f0qvrcz9tbdyatctmah0i.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
